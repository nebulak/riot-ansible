
- hosts: localhost
  vars:
    current_user: "{{ working_user }}"
  #become: false
  become: true
  #become_user: "{{ current_user }}"
  become_method: sudo
  tasks:
  - name: Test
    debug: msg="{{ ansible_env.USER }}"

  - name: Add stretch backports repo
    apt_repository:
      repo: deb http://deb.debian.org/debian stretch-backports main contrib
      state: present
      filename: stretch-backports.list

  - name: "apt-get update"
    apt:
      update_cache: yes

  - name: Install tor
    apt:
      name: tor
      state: latest
      
  - name: Install bzip2
    apt:
      name: bzip2
      state: latest

  - name: Install Gajim with OMEMO support
    apt: name={{item}} state=installed
    with_items:
      - gajim
      - gajim-omemo
      - gajim-httpupload
      - gajim-urlimagepreview
      - gajim-triggers

  - name: Install Thunderbird, Enigmail, TorBirdy
    apt: name={{item}} state=installed
    with_items:
      - thunderbird
      - enigmail
      - torbirdy

  - name: Install Tor-Browser
    apt:
      name: torbrowser-launcher
      state: latest
      default_release: stretch-backports

  - name: wget test
    become: yes
    become_user: "{{ current_user }}"
    get_url:
      url: "https://github.com/nebulak/riot-sh/raw/master/riot.sh"
      dest: "/home/{{ current_user }}/bin/riot.sh"
      mode: 0755


  - name: Install Keepassxc
    become: yes
    become_user: "{{ current_user }}"
    get_url:
      url: "https://github.com/keepassxreboot/keepassxc/releases/download/2.3.3/KeePassXC-2.3.3-x86_64.AppImage"
      dest: "/home/{{ current_user }}/bin/keepassxc"
      mode: 0755

#  - name: Install AppImaged
#    get_url:
#      url: "https://github.com/AppImage/appimaged/releases/download/continuous/appimaged-x86_64.AppImage"
#      dest: "/home/{{ ansible_env.USER }}/.riot-sh/appimaged-x86_64.AppImage"

  - name: Install Firejail
    apt:
      name: firejail
      state: latest
      
  - name: Install Firetools
    apt:
      name: firetools
      state: latest

  - name: Install Magic-Wormhole
    apt:
      name: magic-wormhole
      state: latest

  - name: Install Torjail
    become: yes
    become_user: "{{ current_user }}"
    get_url:
      url: "https://raw.githubusercontent.com/torjail/torjail/master/torjail"
      dest: "/home/{{ current_user }}/bin/torjail"
  
    
  - name: Install restic
    become: yes
    become_user: "{{ current_user }}"
    get_url:
      url: https://github.com/restic/restic/releases/download/v0.9.0/restic_0.9.0_linux_amd64.bz2
      dest: "/home/{{ current_user }}/bin/restic_0.9.0.bz2"

  - name: Unpack restic
    become: yes
    become_user: "{{ current_user }}"
    shell: bzip2 -d "/home/{{ current_user }}/bin/restic_0.9.0.bz2"
    
  - name: Rename restic binary
    become: yes
    become_user: "{{ current_user }}"
    shell: mv "/home/{{ current_user }}/bin/restic_0.9.0" "/home/{{ current_user }}/bin/restic"
    
  - name: Make restic binary executable
    become: yes
    become_user: "{{ current_user }}"
    shell: chmod +x "/home/{{ current_user }}/bin/restic"
      #copy: no
      #src: "/home/{{ current_user }}/bin/restic_0.9.0.bz2" 
      #dest: "/home/{{ current_user }}/bin"
      #creates: "/opt/android/{{ android_ndk_folder }}"
  #- name: Install restic for encrypted backups
    # TODO: https://github.com/restic/restic/releases/tag/v0.8.3

# //TODO: Install tool to setup smartcard for full-disk-encryption
# //TODO: - name: Use gajim only with tor using torjail
